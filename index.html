<html>
	<head>
		<link rel="manifest" href="/manifest.json" />
		<meta name="theme-color" content="#0080FF">
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		Hello world
		<br />
		<button id="a2hs">Add to home screen</button>
		<br />
		<button id="notifications">Add notifications</button>
		<script>
			var serviceWorker = null;
			async function main() {
				if (!('serviceWorker' in navigator))
					return;
				try {
					serviceWorker = await navigator.serviceWorker.register('service-worker.js');
					console.log("Service worker registered");
				} catch (e) {
					console.log("Service worker NOT registered", e);
				}
			}
			main();

			var deferredPrompt = null;
			window.addEventListener('beforeinstallprompt', (e) => {
				console.log("beforeinstallprompt");
				e.preventDefault();
				deferredPrompt = e;
			});
			document.querySelector("#a2hs").addEventListener('click', (e) => {
				if(!deferredPrompt) {
					return;
				}
				deferredPrompt.prompt();
				deferredPrompt.userChoice.then((choiceResult) => {
					if (choiceResult.outcome === 'accepted') {
						console.log('User accepted the A2HS prompt');
					} else {
						console.log('User dismissed the A2HS prompt');
					}
					deferredPrompt = null;
				});
			});

			document.querySelector("#notifications").addEventListener('click', async (e) => {
				await askPermission();
				await subscribeUserToPush(serviceWorker);
			});

				
			function askPermission() {
				return new Promise((resolve, reject) => {
					Notification.requestPermission(result => {
						if (result !== 'granted') {
							reject('We weren\'t granted permission.');
						} else {
							resolve(result);
						}
					});
				});
			}

			async function subscribeUserToPush(serviceWorker) {
				if(!serviceWorker) {
					return;
				}
				const pushSubscription = await serviceWorker.pushManager.subscribe({
					userVisibleOnly: true,
					applicationServerKey: urlBase64ToUint8Array('')
				});
				console.log(JSON.stringify(pushSubscription));
			}
	</script>
	</body>
</html>